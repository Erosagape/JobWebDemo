<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Content/bootstrap.min.css">
    <link rel="stylesheet" href="Content/jquery.datatables.min.css">
    <script src="Scripts/jquery-3.3.1.min.js"></script>
    <script src="Scripts/DataTables/jquery.dataTables.min.js"></script>
    <script src="Scripts/bootstrap.js"></script>
    <script src="Scripts/Func/Util.js"></script>
    <title>Template</title>
</head>
<body>
    <div class="panel-primary">
        <div class="panel-heading">
            <h4 class="panel-title">
                Test File Previewer
            </h4>
        </div>
        <div class="panel-body">            
            <div id="imagesDiv" class="rounded">
                <form id="frmUpLoad" enctype="multipart/form-data">
                    <label id="lblMsg" for="chooseFiles">Add Some Images</label>
                    <input type="file" id="chooseFiles" multiple="multiple" />
                    <table id="previewTable">
                        <thead id="columns"></thead>
                        <tbody id="previews"></tbody>
                    </table>
                </form>
            </div>
        </div>
        <div class="panel-footer">
            <p>&copy; Tawan Technology Co.,ltd</p>
        </div>
    </div>
    <style>
        div.rounded {
            width: 100%;
            border-style: solid;
            border-width: 1px;
            border-radius: 5px;
        }

        label {
            display: block;
        }

        input {
            display: block;
        }

        #previewTable {
            width: 100%;
        }
    </style>
    <script type="text/javascript">
        (function (global) {
            var imagesPerRow = 3,
                chooseFiles,
                columns,
                previews;

            function PreviewImages() {
                var row;

                Array.prototype.forEach.call(chooseFiles.files, function (file, index) {
                    var cindex = index % imagesPerRow,
                        oFReader = new FileReader(),
                        cell,
                        image;

                    if (cindex === 0) {
                        row = previews.insertRow(Math.ceil(index / imagesPerRow));
                    }

                    image = document.createElement("img");
                    image.id = "img_" + index;
                    image.style.width = "100%";
                    image.style.height = "auto";

                    cell = row.insertCell(cindex);
                    cell.appendChild(image);

                    oFReader.addEventListener("load", function assignImageSrc(evt) {
                        image.src = evt.target.result;

                        var data = new FormData();
                        data.append(file.name, file);

                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', 'Config/UploadPicture');
                        xhr.send(data);
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == 4 && xhr.status == 200) {
                                $('#lblMsg').text(xhr.responseText);  
                            }
                        }

                        this.removeEventListener("load", assignImageSrc);
                    }, false);

                    oFReader.readAsDataURL(file);
                });
            }

            global.addEventListener("load", function windowLoadHandler() {
                global.removeEventListener("load", windowLoadHandler);

                chooseFiles = document.getElementById("chooseFiles");
                columns = document.getElementById("columns");
                previews = document.getElementById("previews");

                var row = columns.insertRow(-1),
                    header,
                    i;

                for (i = 0; i < imagesPerRow; i += 1) {
                    header = row.insertCell(-1);
                    header.style.width = (100 / imagesPerRow) + "%";
                }

                chooseFiles.addEventListener("change", PreviewImages, false);
            }, false);
        }(window));
    </script>
</body>
</html>